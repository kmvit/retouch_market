{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Главная - Haron Market{% endblock %}

{% block content %}
  <div class="account">
    <div class="container">
      <div class="title-2 mt-0">Главная</div>
      <div class="banner bg-blue-dark">
        <div class="banner__content">
          <div class="title-2 text-white my-1">Поздравляем!</div>
          <p class="text-gray">Вам доступна новая позиция товара. <br> Вы можете перейти в каталог <br> и добавить товар.</p>
        </div>
        <div class="banner__bg">
          <picture>
            <source media="(max-width: 1200px)" srcset="{% static 'img/account-main-banner-bg-sm.svg' %}"><img src="{% static 'img/account-main-banner-bg.svg' %}" alt="">
          </picture>
        </div>
      </div>
      <div class="row my-1 row-cols-xl-3 row-cols-1 d-none d-xl-flex">
        <div class="col my-05">
          <div class="card p-2 rounded-3">
            <div class="card-body">Новых заявок за сегодня:<br><strong class="fs-3">0</strong></div>
          </div>
        </div>
        <div class="col my-05">
          <div class="card p-2 rounded-3">
            <div class="card-body">Заявок за всё время:<br><strong class="fs-3">0</strong></div>
          </div>
        </div>
        <div class="col my-05">
          <div class="card p-2 rounded-3">
            <div class="card-body">Заработано на платформе:<br><strong class="fs-3">0</strong></div>
          </div>
        </div>
      </div>
      <div class="row d-xl-none my-3">
        <div class="col"> <small class="text-muted">Новых заявок за сегодня:</small><br><strong class="fs-4">0</strong></div>
        <div class="col border-start"><small class="text-muted">Заявок за всё время:</small><br><strong class="fs-4">0</strong></div>
        <div class="col border-start"><small class="text-muted">Заработано на платформе:</small><br><strong class="fs-4">0</strong></div>
      </div>
      <div class="title-3 mt-4">Клиенты</div>
      <div class="my-2"> 
        {% for client in clients %}
        <div class="card-line"> 
        {% endfor %}
      </div>
    </div>
  </div>
{% endblock %}

{% block modals %}
  <div class="modal fade" tabindex="-1" aria-labelledby="choose-city" aria-hidden="true" id="choose-city">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body">
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
          <div class="title-3 mb-2">Выберите город</div>
          <select class="chosen" name="" data-placeholder="Ваш город">
            <option></option>
            <option>Красноярск</option>
            <option>Тюмень</option>
            <option>Красноярск</option>
            <option>Томск</option>
            <option>Красноярск</option>
            <option>Уфа</option>
            <option>Красноярск</option>
            <option>Тюмень</option>
            <option>Красноярск</option>
            <option>Томск</option>
            <option>Красноярск</option>
            <option>Уфа</option>
            <option>Красноярск</option>
            <option>Тюмень</option>
            <option>Красноярск</option>
            <option>Томск</option>
            <option>Красноярск</option>
            <option>Уфа</option>
          </select>
          <button class="btn btn-primary w-100 mt-2">Перейти</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" tabindex="-1" aria-labelledby="order-partner" aria-hidden="true" id="order-partner">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <form class="modal-body">
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
          <div class="title-3 mb-2">Заполните анкету на партнерство!</div>
          <div class="row row-col-md-2">
            <div class="col">
              <label class="mb-1">
                <p class="form-label">Фамилия</p>
                <input class="form-control" type="text" placeholder="Фамилия" required>
              </label>
              <label class="mb-1">
                <p class="form-label">Имя</p>
                <input class="form-control" type="text" placeholder="Имя" required>
              </label>
              <label class="mb-1">
                <p class="form-label">Отчество</p>
                <input class="form-control" type="text" placeholder="Отчество" required>
              </label>
              <label class="mb-1">
                <p class="form-label">Город</p>
                <input class="form-control" type="text" placeholder="Город" required>
              </label>
              <label class="mb-1">
                <p class="form-label">Позиция товара</p>
                <input class="form-control" type="text" placeholder="Позиция товара" required>
              </label>
            </div>
            <div class="col">
              <label class="mb-1">
                <p class="form-label">ИП или ООО</p>
                <input class="form-control" type="text" placeholder="ИП или ООО" required>
              </label>
              <label class="mb-1">
                <p class="form-label">Паспортные данные</p>
                <textarea class="form-control" type="text" placeholder="Паспортные данные" required></textarea>
              </label>
            </div>
          </div>
          <p class="text-muted mb-1">Отправляя данные вы соглашаетесь с <a href="">политикой конфиденциальности </a></p>
          <button class="btn btn-primary">Отправить</button>
        </form>
      </div>
    </div>
  </div>
  <div class="modal fade" tabindex="-1" aria-labelledby="pay-success" aria-hidden="true" id="pay-success">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form class="modal-body p-md-3">
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
          <div class="title-3 mb-2">Оплата прошла успешно!</div>
          <p>Вся информация о заказе отправлена вам на почту. В ближайшее время с вами свяжется поставщик.</p>
          <p>Если будут вопросы - звоните нам!</p><a class="fs-5" href="tel: 8 800 800 80 00"><img class="me-1" src="{% static 'img/phone.svg' %}" alt="">8 800 800 80 00</a>
        </form>
      </div>
    </div>
  </div>
  <div class="modal fade" tabindex="-1" aria-labelledby="account-settings" aria-hidden="true" id="account-settings">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content">
        <div class="modal-body">
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
          <div class="title-2 mt-0 mb-2">Настройки</div>
          <ul class="nav nav-tabs">
            <li class="nav-item">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#account-settings-tab-1" type="button" role="tab">Основная информация</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#account-settings-tab-2" type="button" role="tab">Информация о компании</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#account-settings-tab-3" type="button" role="tab">Безопасность</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#account-settings-tab-4" type="button" role="tab">Подписка и аккаунт</button>
            </li>
          </ul>
          <div class="tab-content py-2">
            <div class="tab-pane fade active show" role="tabpanel" id="account-settings-tab-1">
              <div id="basic-info-message" class="alert" style="display:none;"></div>
              <form id="basic-info-form">
                {% csrf_token %}
                <div class="row row-cols-lg-3 row-cols-md-2 row-cols-1">
                  <div class="col">
                    <label class="mb-1">
                      <p class="form-label form-label--small">Фамилия*</p>
                      <input class="form-control" type="text" name="last_name" id="basic-last-name" value="{{ user.last_name|default:'' }}" required>
                    </label>
                  </div>
                  <div class="col">
                    <label class="mb-1">
                      <p class="form-label form-label--small">Имя *</p>
                      <input class="form-control" type="text" name="first_name" id="basic-first-name" value="{{ user.first_name|default:'' }}" required>
                    </label>
                  </div>
                  <div class="col">
                    <label class="mb-1">
                      <p class="form-label form-label--small">Отчество *</p>
                      <input class="form-control" type="text" name="middle_name" id="basic-middle-name" value="{{ user.middle_name|default:'' }}" required>
                    </label>
                  </div>
                  <div class="col">
                    <label class="mb-1">
                      <p class="form-label form-label--small">Номер телефона *</p>
                      <input class="form-control" type="tel" name="phone" id="basic-phone" value="{{ user.phone|default:'' }}" required>
                    </label>
                  </div>
                  <div class="col">
                    <label class="mb-1">
                      <p class="form-label form-label--small">E-mail*</p>
                      <input class="form-control" type="email" name="email" id="basic-email" value="{{ user.email|default:'' }}" required>
                    </label>
                  </div>
                </div>
                <div class="mt-2">
                  <button type="submit" class="btn btn-outline-primary" id="basic-info-submit-btn">Сохранить</button>
                </div>
              </form>
            </div>
            <div class="tab-pane fade" role="tabpanel" id="account-settings-tab-2">
              <div id="company-info-message" class="alert" style="display:none;"></div>
              <form id="company-info-form">
                {% csrf_token %}
                <div class="row row-cols-lg-3 row-cols-md-2 row-cols-1">
                  <div class="col">
                    <label class="mb-1">
                      <p class="form-label form-label--small">Название компании*</p>
                      <input class="form-control" type="text" name="name" id="company-name" value="{{ company.name|default:'' }}" required>
                    </label>
                  </div>
                  <div class="col">
                    <label class="mb-1">
                      <p class="form-label form-label--small">ИНН *</p>
                      <input class="form-control" type="text" name="inn" id="company-inn" value="{{ company.inn|default:'' }}" required>
                    </label>
                  </div>
                  <div class="col">
                    <label class="mb-1">
                      <p class="form-label form-label--small">Город *</p>
                      <select class="form-control" name="city_id" id="company-city" required>
                        <option value="">Выберите город</option>
                        {% if company.city %}
                        <option value="{{ company.city.id }}" selected>{{ company.city.name }}</option>
                        {% endif %}
                      </select>
                    </label>
                  </div>
                  <div class="col">
                    <label class="mb-1">
                      <p class="form-label form-label--small">Рабочий телефон *</p>
                      <input class="form-control" type="tel" name="work_phone" id="company-work-phone" value="{{ company.work_phone|default:'' }}" required>
                    </label>
                  </div>
                  <div class="col">
                    <label class="mb-1">
                      <p class="form-label form-label--small">E-mail*</p>
                      <input class="form-control" type="email" name="work_email" id="company-work-email" value="{{ company.work_email|default:'' }}" required>
                    </label>
                  </div>
                  <div class="col">
                    <label class="mb-1">
                      <p class="form-label form-label--small">Р/С *</p>
                      <input class="form-control" type="text" name="bank_account" id="company-bank-account" value="{{ company.bank_account|default:'' }}" required>
                    </label>
                  </div>
                </div>
                <div class="mt-2">
                  <button type="submit" class="btn btn-outline-primary" id="company-info-submit-btn">Сохранить</button>
                </div>
              </form>
            </div>
            <div class="tab-pane fade" role="tabpanel" id="account-settings-tab-3">
              <div id="password-message" class="alert" style="display:none;"></div>
              <form id="change-password-form">
                {% csrf_token %}
                <label class="mb-1">
                  <p class="form-label form-label--small">Старый пароль *</p>
                  <input class="form-control" type="password" name="old_password" id="old-password" required>
                </label>
                <label class="mb-1">
                  <p class="form-label form-label--small">Новый пароль *</p>
                  <input class="form-control" type="password" name="new_password" id="new-password" required>
                </label>
                <label class="mb-1">
                  <p class="form-label form-label--small">Повтор пароля *</p>
                  <input class="form-control" type="password" name="confirm_password" id="confirm-password" required>
                </label>
                <div class="mt-2">
                  <button type="submit" class="btn btn-outline-primary" id="change-password-submit-btn">Сохранить</button>
                </div>
              </form>
            </div>
            <div class="tab-pane fade" role="tabpanel" id="account-settings-tab-4">
              <div class="alert alert-primary alert-dismissible fade show" role="alert">
                <div class="text-center">Ваш тарифный план: Мегаплан. Тариф оплачен до: 27.02.2021. </div>
                <button class="btn-close" type="button" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
              <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <div class="text-center">Ваш тариф закончился. Для продолжения выберите и оплатите тариф из списка.</div>
              </div>
              <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <div class="row align-items-center">
                  <div class="col">
                    <div class="text-center">Ваша подписка скоро закончится. Тариф оплачен до: 27.02.2021.</div>
                  </div>
                  <div class="col-auto"><a class="btn btn-danger btn-sm" href="">Оплатить</a></div>
                </div>
              </div>
              <div class="row justify-content-end my-2">
                <div class="col-auto">
                  <div class="form-check form-switch">
                    <input class="form-check-input" id="flexSwitchCheckChecked38049756" type="checkbox" checked>
                    <label class="form-check-label" for="flexSwitchCheckChecked38049756">Автопродление</label>
                  </div>
                </div>
              </div>
              <div class="title-3 mb-2">Тарифы</div>
              <div class="card-line"> 
                <div class="card-line__row align-items-center">
                  <div class="card-line__col">1 месяц <strong>Мегаплан</strong></div>
                  <div class="card-line__col-auto">800 руб</div>
                  <div class="card-line__col-auto"><a class="btn btn-success btn-sm" href="">Оплатить </a></div>
                </div>
              </div>
              <div class="card-line"> 
                <div class="card-line__row align-items-center">
                  <div class="card-line__col">1 месяц <strong>Мегаплан</strong></div>
                  <div class="card-line__col-auto">800 руб</div>
                  <div class="card-line__col-auto"><a class="btn btn-success btn-sm" href="">Оплатить </a></div>
                </div>
              </div>
              <div class="card-line"> 
                <div class="card-line__row align-items-center">
                  <div class="card-line__col">1 месяц <strong>Мегаплан</strong></div>
                  <div class="card-line__col-auto">800 руб</div>
                  <div class="card-line__col-auto"><a class="btn btn-success btn-sm" href="">Оплатить </a></div>
                </div>
              </div>
              <div class="card-line bg-primary">
                <div class="card-line__row align-items-center">
                  <div class="card-line__col text-white">1 месяц <strong>Мегаплан</strong></div>
                  <div class="card-line__col-auto text-white">800 руб</div>
                  <div class="card-line__col-auto"><a class="btn btn-success btn-sm" href="">Оплатить </a></div>
                </div>
              </div>
              <div class="card-line bg-success">
                <div class="card-line__row align-items-center">
                  <div class="card-line__col text-white">1 месяц <strong>Мегаплан</strong></div>
                  <div class="card-line__col-auto text-white">800 руб</div>
                  <div class="card-line__col-auto"><a class="btn btn-primary btn-sm" href="">Оплатить </a></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
  // Обработка формы основной информации
  $('#basic-info-form').on('submit', function(e) {
    e.preventDefault();
    
    const form = $(this);
    const submitBtn = $('#basic-info-submit-btn');
    const messageDiv = $('#basic-info-message');
    
    // Получаем данные из формы
    const formData = {
      first_name: $('#basic-first-name').val().trim(),
      last_name: $('#basic-last-name').val().trim(),
      middle_name: $('#basic-middle-name').val().trim(),
      phone: $('#basic-phone').val().trim(),
      email: $('#basic-email').val().trim()
    };
    
    // Валидация на клиенте
    const requiredFields = ['first_name', 'last_name', 'middle_name', 'phone', 'email'];
    const missingFields = requiredFields.filter(field => !formData[field]);
    
    if (missingFields.length > 0) {
      showMessage('Заполните все обязательные поля', 'error');
      return;
    }
    
    // Блокируем кнопку
    submitBtn.prop('disabled', true).text('Сохранение...');
    
    // Отправляем данные
    $.ajax({
      url: '{% url "accounts:update-basic-info" %}',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(formData),
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
      },
      success: function(response) {
        if (response.success) {
          showMessage(response.message, 'success');
          // Обновляем имя в хедере, если оно изменилось
          const fullName = formData.last_name + ' ' + formData.first_name + ' ' + formData.middle_name;
          $('.header-account__name').text(fullName.trim());
        } else {
          showMessage(response.message, 'error');
        }
      },
      error: function(xhr) {
        const response = xhr.responseJSON || {};
        showMessage(response.message || 'Ошибка сохранения данных. Попробуйте позже.', 'error');
      },
      complete: function() {
        submitBtn.prop('disabled', false).text('Сохранить');
      }
    });
  });
  
  function showMessage(message, type) {
    const messageDiv = $('#basic-info-message');
    messageDiv.removeClass('alert-success alert-danger');
    messageDiv.addClass(type === 'success' ? 'alert-success' : 'alert-danger');
    messageDiv.text(message).slideDown();
    
    if (type === 'success') {
      setTimeout(function() {
        messageDiv.slideUp();
      }, 3000);
    }
  }
  
  // Загружаем список городов для формы компании
  function loadCitiesForCompany() {
    $.ajax({
      url: '{% url "accounts:get-cities" %}',
      method: 'GET',
      success: function(response) {
        if (response.success) {
          const citySelect = $('#company-city');
          const currentCityId = citySelect.find('option:selected').val();
          citySelect.empty();
          citySelect.append('<option value="">Выберите город</option>');
          response.cities.forEach(function(city) {
            const selected = city.id == currentCityId ? 'selected' : '';
            citySelect.append(`<option value="${city.id}" ${selected}>${city.name}</option>`);
          });
        }
      },
      error: function() {
        console.error('Ошибка загрузки списка городов');
      }
    });
  }
  
  // Загружаем города при открытии вкладки "Информация о компании"
  $('button[data-bs-target="#account-settings-tab-2"]').on('click', function() {
    loadCitiesForCompany();
  });
  
  // Обработка формы информации о компании
  $('#company-info-form').on('submit', function(e) {
    e.preventDefault();
    
    const form = $(this);
    const submitBtn = $('#company-info-submit-btn');
    const messageDiv = $('#company-info-message');
    
    // Получаем данные из формы
    const formData = {
      name: $('#company-name').val().trim(),
      inn: $('#company-inn').val().trim(),
      city_id: $('#company-city').val(),
      work_phone: $('#company-work-phone').val().trim(),
      work_email: $('#company-work-email').val().trim(),
      bank_account: $('#company-bank-account').val().trim()
    };
    
    // Валидация на клиенте
    const requiredFields = ['name', 'inn', 'city_id', 'work_phone', 'work_email', 'bank_account'];
    const missingFields = requiredFields.filter(field => !formData[field]);
    
    if (missingFields.length > 0) {
      showCompanyMessage('Заполните все обязательные поля', 'error');
      return;
    }
    
    // Блокируем кнопку
    submitBtn.prop('disabled', true).text('Сохранение...');
    
    // Отправляем данные
    $.ajax({
      url: '{% url "accounts:update-company-info" %}',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(formData),
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
      },
      success: function(response) {
        if (response.success) {
          showCompanyMessage(response.message, 'success');
        } else {
          showCompanyMessage(response.message, 'error');
        }
      },
      error: function(xhr) {
        const response = xhr.responseJSON || {};
        showCompanyMessage(response.message || 'Ошибка сохранения данных. Попробуйте позже.', 'error');
      },
      complete: function() {
        submitBtn.prop('disabled', false).text('Сохранить');
      }
    });
  });
  
  function showCompanyMessage(message, type) {
    const messageDiv = $('#company-info-message');
    messageDiv.removeClass('alert-success alert-danger');
    messageDiv.addClass(type === 'success' ? 'alert-success' : 'alert-danger');
    messageDiv.text(message).slideDown();
    
    if (type === 'success') {
      setTimeout(function() {
        messageDiv.slideUp();
      }, 3000);
    }
  }
  
  // Обработка формы смены пароля
  $('#change-password-form').on('submit', function(e) {
    e.preventDefault();
    
    const form = $(this);
    const submitBtn = $('#change-password-submit-btn');
    const messageDiv = $('#password-message');
    
    // Получаем данные из формы
    const oldPassword = $('#old-password').val();
    const newPassword = $('#new-password').val();
    const confirmPassword = $('#confirm-password').val();
    
    // Валидация на клиенте
    if (!oldPassword || !newPassword || !confirmPassword) {
      showPasswordMessage('Заполните все поля', 'error');
      return;
    }
    
    // Проверка совпадения паролей
    if (newPassword !== confirmPassword) {
      showPasswordMessage('Новые пароли не совпадают', 'error');
      return;
    }
    
    // Проверка минимальной длины пароля
    if (newPassword.length < 8) {
      showPasswordMessage('Пароль должен содержать минимум 8 символов', 'error');
      return;
    }
    
    // Блокируем кнопку
    submitBtn.prop('disabled', true).text('Сохранение...');
    
    // Отправляем данные
    $.ajax({
      url: '{% url "accounts:change-password" %}',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({
        old_password: oldPassword,
        new_password: newPassword,
        confirm_password: confirmPassword
      }),
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
      },
      success: function(response) {
        if (response.success) {
          showPasswordMessage(response.message, 'success');
          // Очищаем форму после успешной смены пароля
          $('#change-password-form')[0].reset();
        } else {
          showPasswordMessage(response.message, 'error');
        }
      },
      error: function(xhr) {
        const response = xhr.responseJSON || {};
        showPasswordMessage(response.message || 'Ошибка смены пароля. Попробуйте позже.', 'error');
      },
      complete: function() {
        submitBtn.prop('disabled', false).text('Сохранить');
      }
    });
  });
  
  function showPasswordMessage(message, type) {
    const messageDiv = $('#password-message');
    messageDiv.removeClass('alert-success alert-danger');
    messageDiv.addClass(type === 'success' ? 'alert-success' : 'alert-danger');
    messageDiv.text(message).slideDown();
    
    if (type === 'success') {
      setTimeout(function() {
        messageDiv.slideUp();
      }, 3000);
    }
  }
});
</script>
{% endblock %}
