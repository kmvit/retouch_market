{% extends 'base.html' %}
{% load static %}

{% block title %}Каталог - Haron Market{% endblock %}

{% block content %}
        <div class="container py-1">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="{% url 'core:index' %}">Главная</a></li>
              <li class="breadcrumb-item active" aria-current="page">Каталог</li>
            </ol>
          </nav>
          <form method="get" action="{% url 'catalog:catalog' %}" class="search">
            <input class="form-control" type="text" name="q" placeholder="Поиск" value="{{ search_query }}">
            <button type="submit" class="search-btn"><img src="{% static 'img/search.svg' %}" alt=""></button>
          </form>
          <form method="get" action="{% url 'catalog:catalog' %}" id="sort-form">
            {% if search_query %}
              <input type="hidden" name="q" value="{{ search_query }}">
            {% endif %}
            <div class="sort my-1">
              <div class="sort__text">Сортировать по:</div>
              <label class="sort__label">
                <input type="radio" name="sort" value="price_asc" {% if sort_by == 'price_asc' %}checked{% endif %} hidden onchange="this.form.submit()">
                <div class="sort__label-text">По цене (дешевые)</div>
              </label>
              <label class="sort__label">
                <input type="radio" name="sort" value="price_desc" {% if sort_by == 'price_desc' %}checked{% endif %} hidden onchange="this.form.submit()">
                <div class="sort__label-text">По цене (дорогие)</div>
              </label>
              <label class="sort__label">
                <input type="radio" name="sort" value="name" {% if sort_by == 'name' %}checked{% endif %} hidden onchange="this.form.submit()">
                <div class="sort__label-text">По алфавиту</div>
              </label>
              <label class="sort__label">
                <input type="radio" name="sort" value="date" {% if sort_by == 'date' or not sort_by %}checked{% endif %} hidden onchange="this.form.submit()">
                <div class="sort__label-text">По дате (новые)</div>
              </label>
            </div>
          </form>
          <script>
            // Обработка клика по label для скрытых radio buttons
            document.querySelectorAll('#sort-form .sort__label').forEach(function(label) {
              label.addEventListener('click', function(e) {
                var radio = this.querySelector('input[type="radio"]');
                if (radio && !radio.checked) {
                  radio.checked = true;
                  radio.dispatchEvent(new Event('change'));
                }
              });
            });
          </script>
          {% if is_search %}
            {% if search_query %}
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                  <div class="title-2 mb-0">Результаты поиска по запросу "{{ search_query }}"</div>
                  {% if search_results %}
                    <small class="text-muted">Найдено товаров: {{ search_results|length }}</small>
                  {% endif %}
                </div>
                <a href="{% url 'catalog:catalog' %}" class="btn btn-sm btn-outline-secondary">Очистить поиск</a>
              </div>
              {% if search_results %}
                <div class="row row-cols-xl-4 row-cols-md-3 row-cols-2">
                  {% for product in search_results %}
                  <div class="col">
                    <div class="card-product">
                      <div class="card-product__img">
                        <div>
                          {% if product.images.all %}
                            {% with main_image=product.images.all|first %}
                              <img src="{{ main_image.image.url }}" alt="{{ main_image.alt_text|default:product.name }}"/>
                            {% endwith %}
                          {% else %}
                            <img src="{% static 'img/item.svg' %}" alt="{{ product.name }}"/>
                          {% endif %}
                        </div>
                      </div>
                      <a class="card-product__title" href="{% url 'catalog:detail' product_id=product.id %}">{{ product.name }}</a>
                      <div class="card-product__price">
                        {% if product.discount_price %}
                          <nobr class="_old">{{ product.price|floatformat:2 }} руб.</nobr>
                          <nobr>от {{ product.discount_price|floatformat:2 }} руб.</nobr>
                        {% else %}
                          от {{ product.price|floatformat:2 }} руб.
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="alert alert-info">По запросу "{{ search_query }}" ничего не найдено.</div>
              {% endif %}
            {% endif %}
          {% else %}
            {% for item in categories_with_products %}
            <div class="title-2">{{ item.category.name }}</div>
            <div class="row row-cols-xl-4 row-cols-md-3 row-cols-2">
              {% for product in item.products %}
              <div class="col">
                <div class="card-product">
                  <div class="card-product__img">
                    <div>
                      {% if product.images.all %}
                        {% with main_image=product.images.all|first %}
                          <img src="{{ main_image.image.url }}" alt="{{ main_image.alt_text|default:product.name }}"/>
                        {% endwith %}
                      {% else %}
                        <img src="{% static 'img/item.svg' %}" alt="{{ product.name }}"/>
                      {% endif %}
                    </div>
                  </div>
                  <a class="card-product__title" href="{% url 'catalog:detail' product_id=product.id %}">{{ product.name }}</a>
                  <div class="card-product__price">
                    {% if product.discount_price %}
                      <nobr class="_old">{{ product.price|floatformat:2 }} руб.</nobr>
                      <nobr>от {{ product.discount_price|floatformat:2 }} руб.</nobr>
                    {% else %}
                      от {{ product.price|floatformat:2 }} руб.
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% empty %}
            <div class="alert alert-info">Товары пока не добавлены в каталог.</div>
            {% endfor %}
          {% endif %}
        </div>
{% endblock %}

{% block modals %}
    <div class="modal fade" tabindex="-1" aria-labelledby="choose-city" aria-hidden="true" id="choose-city">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body">
            <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
            <div class="title-3 mb-2">Выберите город</div>
            <select class="chosen" name="" data-placeholder="Ваш город">
              <option></option>
              <option>Красноярск</option>
              <option>Тюмень</option>
              <option>Красноярск</option>
              <option>Томск</option>
              <option>Красноярск</option>
              <option>Уфа</option>
              <option>Красноярск</option>
              <option>Тюмень</option>
              <option>Красноярск</option>
              <option>Томск</option>
              <option>Красноярск</option>
              <option>Уфа</option>
              <option>Красноярск</option>
              <option>Тюмень</option>
              <option>Красноярск</option>
              <option>Томск</option>
              <option>Красноярск</option>
              <option>Уфа</option>
            </select>
            <button class="btn btn-primary w-100 mt-2">Перейти</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" tabindex="-1" aria-labelledby="order-partner" aria-hidden="true" id="order-partner">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <form class="modal-body">
            <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
            <div class="title-3 mb-2">Заполните анкету на партнерство!</div>
            <div class="row row-col-md-2">
              <div class="col">
                <label class="mb-1">
                  <p class="form-label">Фамилия</p>
                  <input class="form-control" type="text" placeholder="Фамилия" required>
                </label>
                <label class="mb-1">
                  <p class="form-label">Имя</p>
                  <input class="form-control" type="text" placeholder="Имя" required>
                </label>
                <label class="mb-1">
                  <p class="form-label">Отчество</p>
                  <input class="form-control" type="text" placeholder="Отчество" required>
                </label>
                <label class="mb-1">
                  <p class="form-label">Город</p>
                  <input class="form-control" type="text" placeholder="Город" required>
                </label>
                <label class="mb-1">
                  <p class="form-label">Позиция товара</p>
                  <input class="form-control" type="text" placeholder="Позиция товара" required>
                </label>
              </div>
              <div class="col">
                <label class="mb-1">
                  <p class="form-label">ИП или ООО</p>
                  <input class="form-control" type="text" placeholder="ИП или ООО" required>
                </label>
                <label class="mb-1">
                  <p class="form-label">Паспортные данные</p>
                  <textarea class="form-control" type="text" placeholder="Паспортные данные" required></textarea>
                </label>
              </div>
            </div>
            <p class="text-muted mb-1">Отправляя данные вы соглашаетесь с <a href="">политикой конфиденциальности </a></p>
            <button class="btn btn-primary">Отправить</button>
          </form>
        </div>
      </div>
    </div>
    <div class="modal fade" tabindex="-1" aria-labelledby="pay-success" aria-hidden="true" id="pay-success">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form class="modal-body p-md-3">
            <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
            <div class="title-3 mb-2">Оплата прошла успешно!</div>
            <p>Вся информация о заказе отправлена вам на почту. В ближайшее время с вами свяжется поставщик.</p>
            <p>Если будут вопросы - звоните нам!</p><a class="fs-5" href="tel: 8 800 800 80 00"><img class="me-1" src="{% static 'img/phone.svg' %}" alt="">8 800 800 80 00</a>
          </form>
        </div>
      </div>
    </div>
    <div class="modal fade" tabindex="-1" aria-labelledby="account-settings" aria-hidden="true" id="account-settings">
      <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
          <div class="modal-body">
            <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
            <div class="title-2 mt-0 mb-2">Настройки</div>
            <ul class="nav nav-tabs">
              <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#account-settings-tab-1" type="button" role="tab">Основная информация</button>
              </li>
              <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#account-settings-tab-2" type="button" role="tab">Информация о компании</button>
              </li>
              <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#account-settings-tab-3" type="button" role="tab">Безопасность</button>
              </li>
              <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#account-settings-tab-4" type="button" role="tab">Подписка и аккаунт</button>
              </li>
            </ul>
            <div class="tab-content py-2">
              <div class="tab-pane fade active show" role="tabpanel" id="account-settings-tab-1">
                <form>
                  <div class="row row-cols-lg-3 row-cols-md-2 row-cols-1">
                    <div class="col">
                      <label class="mb-1">
                        <p class="form-label form-label--small">Фамилия*</p>
                        <input class="form-control" type="text" value="" required>
                      </label>
                    </div>
                    <div class="col">
                      <label class="mb-1">
                        <p class="form-label form-label--small">Имя *</p>
                        <input class="form-control" type="text" value="Евгения" required>
                      </label>
                    </div>
                    <div class="col">
                      <label class="mb-1">
                        <p class="form-label form-label--small">Отчество *</p>
                        <input class="form-control" type="text" value="Сергеевна" required>
                      </label>
                    </div>
                    <div class="col">
                      <label class="mb-1">
                        <p class="form-label form-label--small">Номер телефона *</p>
                        <input class="form-control" type="tel" value="+7 (908) 667-78-76" required>
                      </label>
                    </div>
                    <div class="col">
                      <label class="mb-1">
                        <p class="form-label form-label--small">E-mail*</p>
                        <input class="form-control" type="email" value="pochta@gmail.com" required>
                      </label>
                    </div>
                  </div>
                  <div class="mt-2">
                    <button class="btn btn-outline-primary">Сохранить</button>
                  </div>
                </form>
              </div>
              <div class="tab-pane fade" role="tabpanel" id="account-settings-tab-2">
                <form>
                  <div class="row row-cols-lg-3 row-cols-md-2 row-cols-1">
                    <div class="col">
                      <label class="mb-1">
                        <p class="form-label form-label--small">Название компании*</p>
                        <input class="form-control" type="text" required>
                      </label>
                    </div>
                    <div class="col">
                      <label class="mb-1">
                        <p class="form-label form-label--small">ИНН *</p>
                        <input class="form-control" type="text" required>
                      </label>
                    </div>
                    <div class="col">
                      <label class="mb-1">
                        <p class="form-label form-label--small">Город *</p>
                        <input class="form-control" type="text" required>
                      </label>
                    </div>
                    <div class="col">
                      <label class="mb-1">
                        <p class="form-label form-label--small">Рабочий телефон *</p>
                        <input class="form-control" type="tel" required>
                      </label>
                    </div>
                    <div class="col">
                      <label class="mb-1">
                        <p class="form-label form-label--small">E-mail*</p>
                        <input class="form-control" type="email" required>
                      </label>
                    </div>
                    <div class="col">
                      <label class="mb-1">
                        <p class="form-label form-label--small">Р/С *</p>
                        <input class="form-control" type="text" required>
                      </label>
                    </div>
                  </div>
                  <div class="mt-2">
                    <button class="btn btn-outline-primary">Сохранить</button>
                  </div>
                </form>
              </div>
              <div class="tab-pane fade" role="tabpanel" id="account-settings-tab-3">
                <form class="needs-validation" novalidate>
                  <label class="mb-1">
                    <p class="form-label form-label--small">Старый пароль *</p>
                    <input class="form-control" type="password" required>
                    <div class="invalid-feedback">Неверно введен пароль</div>
                  </label>
                  <label class="mb-1">
                    <p class="form-label form-label--small">Новый пароль *</p>
                    <input class="form-control" type="password" required>
                  </label>
                  <label class="mb-1">
                    <p class="form-label form-label--small">Повтор пароля *</p>
                    <input class="form-control" type="password" required>
                    <div class="invalid-feedback">Пароли не совпадают</div>
                  </label>
                  <div class="mt-2">
                    <button class="btn btn-outline-primary">Сохранить</button>
                  </div>
                </form>
              </div>
              <div class="tab-pane fade" role="tabpanel" id="account-settings-tab-4">
                <div class="alert alert-primary alert-dismissible fade show" role="alert">
                  <div class="text-center">Ваш тарифный план: Мегаплан. Тариф оплачен до: 27.02.2021. </div>
                  <button class="btn-close" type="button" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                  <div class="text-center">Ваш тариф закончился. Для продолжения выберите и оплатите тариф из списка.</div>
                </div>
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                  <div class="row align-items-center">
                    <div class="col">
                      <div class="text-center">Ваша подписка скоро закончится. Тариф оплачен до: 27.02.2021.</div>
                    </div>
                    <div class="col-auto"><a class="btn btn-danger btn-sm" href="">Оплатить</a></div>
                  </div>
                </div>
                <div class="row justify-content-end my-2">
                  <div class="col-auto">
                    <div class="form-check form-switch">
                      <input class="form-check-input" id="flexSwitchCheckChecked38049756" type="checkbox" checked>
                      <label class="form-check-label" for="flexSwitchCheckChecked38049756">Автопродление</label>
                    </div>
                  </div>
                </div>
                <div class="title-3 mb-2">Тарифы</div>
                <div class="card-line"> 
                  <div class="card-line__row align-items-center">
                    <div class="card-line__col">1 месяц <strong>Мегаплан</strong></div>
                    <div class="card-line__col-auto">800 руб</div>
                    <div class="card-line__col-auto"><a class="btn btn-success btn-sm" href="">Оплатить </a></div>
                  </div>
                </div>
                <div class="card-line"> 
                  <div class="card-line__row align-items-center">
                    <div class="card-line__col">1 месяц <strong>Мегаплан</strong></div>
                    <div class="card-line__col-auto">800 руб</div>
                    <div class="card-line__col-auto"><a class="btn btn-success btn-sm" href="">Оплатить </a></div>
                  </div>
                </div>
                <div class="card-line"> 
                  <div class="card-line__row align-items-center">
                    <div class="card-line__col">1 месяц <strong>Мегаплан</strong></div>
                    <div class="card-line__col-auto">800 руб</div>
                    <div class="card-line__col-auto"><a class="btn btn-success btn-sm" href="">Оплатить </a></div>
                  </div>
                </div>
                <div class="card-line bg-primary">
                  <div class="card-line__row align-items-center">
                    <div class="card-line__col text-white">1 месяц <strong>Мегаплан</strong></div>
                    <div class="card-line__col-auto text-white">800 руб</div>
                    <div class="card-line__col-auto"><a class="btn btn-success btn-sm" href="">Оплатить </a></div>
                  </div>
                </div>
                <div class="card-line bg-success">
                  <div class="card-line__row align-items-center">
                    <div class="card-line__col text-white">1 месяц <strong>Мегаплан</strong></div>
                    <div class="card-line__col-auto text-white">800 руб</div>
                    <div class="card-line__col-auto"><a class="btn btn-primary btn-sm" href="">Оплатить </a></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endblock %}
