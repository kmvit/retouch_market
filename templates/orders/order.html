{% extends 'base.html' %}
{% load static %}

{% block title %}Оформление заказа - Haron Market{% endblock %}

{% block content %}
  <div class="container">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'core:index' %}">Главная</a></li>
        <li class="breadcrumb-item"><a href="{% url 'catalog:catalog' %}">Каталог</a></li>
        <li class="breadcrumb-item"><a href="{% url 'cart:detail' %}">Корзина</a></li>
        <li class="breadcrumb-item active" aria-current="page">Оформление заказа</li>
      </ol>
    </nav>
    <form method="post" class="card p-2 rounded-3">
      {% csrf_token %}
      <div class="row"> 
        <div class="col-md-12">
          {% for item in cart_items %}
            <div class="cart-elem mb-2">
              <div class="cart-elem__img">
                {% if item.product.images.all %}
                  {% with main_image=item.product.images.all|first %}
                    <img src="{{ main_image.image.url }}" alt="{{ main_image.alt_text|default:item.product.name }}">
                  {% endwith %}
                {% else %}
                  <img src="{% static 'img/item.svg' %}" alt="{{ item.product.name }}">
                {% endif %}
              </div>
              <div class="cart-elem__content">
                <div class="mb-1">
                  <a class="title-3" href="{% url 'catalog:detail' product_id=item.product.id %}">{{ item.product.name }}</a>
                </div>
                <div class="row">
                  {% if item.product.category %}
                    <div class="col-auto mb-1">Категория: {{ item.product.category.name }}</div>
                  {% endif %}
                  {% if item.product.color %}
                    <div class="col-auto mb-1">Цвет: {{ item.product.get_color_display }}</div>
                  {% endif %}
                  {% if item.product.shape %}
                    <div class="col-auto mb-1">Форма: {{ item.product.get_shape_display }}</div>
                  {% endif %}
                  <div class="col-auto mb-1">Количество: {{ item.quantity }}</div>
                </div>
                <div class="cart-elem__total">
                  <div>Всего:</div>
                  {% if item.old_total_price %}
                    <div class="_old">{{ item.old_total_price|floatformat:2 }} руб.</div>
                  {% endif %}
                  <div>{{ item.total_price|floatformat:2 }} руб.</div>
                </div>
              </div>
            </div>
          {% endfor %}
          <hr class="my-2">
          <div class="row row-cols-md-2 row-cols-1">
            <div class="col pe-md-2">
              <label class="mb-1">
                <p class="form-label">Фамилия</p>
                <input class="form-control" type="text" name="last_name" placeholder="Фамилия" value="{{ form_data.last_name|default:'' }}" required>
              </label>
              <label class="mb-1">
                <p class="form-label">Имя</p>
                <input class="form-control" type="text" name="first_name" placeholder="Имя" value="{{ form_data.first_name|default:'' }}" required>
              </label>
              <label class="mb-1">
                <p class="form-label">Отчество</p>
                <input class="form-control" type="text" name="middle_name" placeholder="Отчество" value="{{ form_data.middle_name|default:'' }}">
              </label>
              <label class="mb-1">
                <p class="form-label">Почта *</p>
                <input class="form-control" type="email" name="email" placeholder="Почта" value="{{ form_data.email|default:'' }}" required>
              </label>
              <label class="mb-1">
                <p class="form-label">Номер телефона</p>
                <input class="form-control" type="tel" name="phone" placeholder="Номер телефона" value="{{ form_data.phone|default:'' }}">
              </label>
            </div>
            <div class="col ps-md-2 border-md-start">
              <label class="mb-1">
                <p class="form-label">Адрес доставки</p>
                <textarea class="form-control" name="address" placeholder="Адрес доставки" rows="3">{{ form_data.address|default:'' }}</textarea>
              </label>
              <label class="mb-1">
                <p class="form-label">Комментарий к заказу</p>
                <textarea class="form-control" name="comment" placeholder="Комментарий к заказу (необязательно)" rows="3">{{ form_data.comment|default:'' }}</textarea>
              </label>
            </div>
          </div>
          <hr class="my-2">
        </div>
        <div class="col-xl-4 col-lg-5 col-md-6">
          <div class="title-3">Итого</div>
          <hr>
          <div class="row justify-content-between text-blue-dark mb-2">
            <div class="col-auto">Товаров:</div>
            <div class="col-auto">{{ cart.total_quantity }}</div>
          </div>
          <div class="row justify-content-between text-blue-dark">
            <div class="col-auto">Всего:</div>
            <div class="col-auto">{{ cart.total_amount|floatformat:2 }} рублей</div>
          </div>
          <div class="mt-2">
            <label>
              <input type="checkbox" name="privacy_policy" hidden required>
              <div class="label-check">Я согласен с политикой конфиденциальности *</div>
            </label>
          </div>
          <button type="submit" class="btn btn-primary mt-1 w-100">Оформить заказ</button>
        </div>
      </div>
    </form>
  </div>
{% endblock %}

{% block modals %}
    <div class="modal fade" tabindex="-1" aria-labelledby="pay-success" aria-hidden="true" id="pay-success">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form class="modal-body p-md-3">
            <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
            <div class="title-3 mb-2">Оплата прошла успешно!</div>
            <p>Вся информация о заказе отправлена вам на почту. В ближайшее время с вами свяжется поставщик.</p>
            <p>Если будут вопросы - звоните нам!</p><a class="fs-5" href="tel: 8 800 800 80 00"><img class="me-1" src="{% static 'img/phone.svg' %}" alt="">8 800 800 80 00</a>
          </form>
        </div>
      </div>
    </div>
{% endblock %}
