{% extends 'base.html' %}
{% load static %}

{% block title %}Корзина - Haron Market{% endblock %}

{% block content %}
  <div class="container">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'core:index' %}">Главная</a></li>
        <li class="breadcrumb-item"><a href="{% url 'catalog:catalog' %}">Каталог</a></li>
        <li class="breadcrumb-item active" aria-current="page">Корзина</li>
      </ol>
    </nav>
    {% if cart_items %}
      <div class="row"> 
        <div class="col-xl-8 col-lg-7 col-md-12">
          {% for item in cart_items %}
            <div class="card p-md-2 p-1 rounded-3 mb-2" id="cart-item-{{ item.id }}">
              <div class="cart-elem">
                <div class="cart-elem__img">
                  {% if item.product.images.all %}
                    {% with main_image=item.product.images.all|first %}
                      <img src="{{ main_image.image.url }}" alt="{{ main_image.alt_text|default:item.product.name }}">
                    {% endwith %}
                  {% else %}
                    <img src="{% static 'img/item.svg' %}" alt="{{ item.product.name }}">
                  {% endif %}
                </div>
                <div class="cart-elem__content">
                  <div class="mb-1">
                    <a class="title-3" href="{% url 'catalog:detail' product_id=item.product.id %}">{{ item.product.name }}</a>
                  </div>
                  <div class="row">
                    {% if item.product.category %}
                      <div class="col-auto mb-1">Категория: {{ item.product.category.name }}</div>
                    {% endif %}
                    {% if item.product.color %}
                      <div class="col-auto mb-1">Цвет: {{ item.product.get_color_display }}</div>
                    {% endif %}
                    {% if item.product.shape %}
                      <div class="col-auto mb-1">Форма: {{ item.product.get_shape_display }}</div>
                    {% endif %}
                    <div class="col-auto mb-1">Количество: 
                      <input type="number" 
                             min="1" 
                             value="{{ item.quantity }}" 
                             class="form-control d-inline-block" 
                             style="width: 80px;"
                             data-item-id="{{ item.id }}"
                             onchange="updateCartItem({{ item.id }}, this.value)">
                    </div>
                    <div class="col-auto mb-1">
                      <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart({{ item.id }})">Удалить</button>
                    </div>
                  </div>
                  <div class="cart-elem__total">
                    <div>Всего:</div>
                    {% if item.old_total_price %}
                      <div class="_old">{{ item.old_total_price|floatformat:2 }} руб.</div>
                    {% endif %}
                    <div>{{ item.total_price|floatformat:2 }} руб.</div>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
        <div class="col-xl-4 col-lg-5 col-md-12">
          <div class="card p-md-2 p-1 rounded-3">
            <div class="title-3">Итого</div>
            <hr>
            <div class="row justify-content-between text-blue-dark mb-2">
              <div class="col-auto">Товаров:</div>
              <div class="col-auto" id="cart-total-quantity">{{ cart.total_quantity }}</div>
            </div>
            <div class="row justify-content-between text-blue-dark">
              <div class="col-auto">Всего:</div>
              <div class="col-auto" id="cart-total-amount">{{ cart.total_amount|floatformat:2 }} рублей</div>
            </div>
            <a class="btn btn-primary mt-1 w-100" href="{% url 'orders:create' %}">Оформить заказ</a>
          </div>
        </div>
      </div>
    {% else %}
      <div class="row">
        <div class="col-12">
          <div class="card p-md-4 p-3 rounded-3 text-center">
            <h3 class="mb-3">Корзина пуста</h3>
            <p class="text-muted mb-3">В вашей корзине пока нет товаров</p>
            <a class="btn btn-primary" href="{% url 'catalog:catalog' %}">Перейти в каталог</a>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
{% endblock %}

{% block modals %}
    <div class="modal fade" tabindex="-1" aria-labelledby="pay-success" aria-hidden="true" id="pay-success">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form class="modal-body p-md-3">
            <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
            <div class="title-3 mb-2">Оплата прошла успешно!</div>
            <p>Вся информация о заказе отправлена вам на почту. В ближайшее время с вами свяжется поставщик.</p>
            <p>Если будут вопросы - звоните нам!</p><a class="fs-5" href="tel: 8 800 800 80 00"><img class="me-1" src="{% static 'img/phone.svg' %}" alt="">8 800 800 80 00</a>
          </form>
        </div>
      </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function getCsrfToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
}

function updateCartItem(itemId, quantity) {
  if (quantity < 1) {
    quantity = 1;
    document.querySelector(`input[data-item-id="${itemId}"]`).value = 1;
  }
  
  const formData = new FormData();
  formData.append('quantity', quantity);
  
  fetch(`{% url 'cart:update' item_id=0 %}`.replace('0', itemId), {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
      'X-CSRFToken': getCsrfToken()
    },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Обновляем итоговые значения
      document.getElementById('cart-total-quantity').textContent = data.cart_total_quantity;
      document.getElementById('cart-total-amount').textContent = parseFloat(data.cart_total_amount).toFixed(2) + ' рублей';
      
      // Перезагружаем страницу для обновления всех цен
      location.reload();
    }
  })
  .catch(error => {
    console.error('Ошибка:', error);
    alert('Произошла ошибка при обновлении количества');
  });
}

function removeFromCart(itemId) {
  if (!confirm('Вы уверены, что хотите удалить этот товар из корзины?')) {
    return;
  }
  
  fetch(`{% url 'cart:remove' item_id=0 %}`.replace('0', itemId), {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
      'X-CSRFToken': getCsrfToken()
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Удаляем элемент из DOM
      const itemElement = document.getElementById(`cart-item-${itemId}`);
      if (itemElement) {
        itemElement.remove();
      }
      
      // Обновляем итоговые значения
      document.getElementById('cart-total-quantity').textContent = data.cart_total_quantity;
      document.getElementById('cart-total-amount').textContent = parseFloat(data.cart_total_amount).toFixed(2) + ' рублей';
      
      // Если корзина пуста, перезагружаем страницу
      if (data.cart_total_quantity === 0) {
        location.reload();
      }
    }
  })
  .catch(error => {
    console.error('Ошибка:', error);
    location.reload();
  });
}
</script>
{% endblock %}
